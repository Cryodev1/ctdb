datasource db {
  provider = "postgresql"
  url = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}



// enums
enum Pronoun {
  HE
  SHE
  THEY
}

enum Playstyle {
  DAS
  TAP
  ROLL
}

enum RomVersion {
  NTSC
  PAL
  NTSC_CUSTOM
  PAL_CUSTOM
}

enum MatchType {
  FRIENDLY
  COMPETITIVE
  CHAMPIONSHIP
}

// Base organization model
// CTM, CTL, CTG, CTWC are examples
model Organization {
  id          Int @id @default(autoincrement())
  name        String @db.VarChar(64) @unique
  description String
  members     User[]   // staff
  events      Event[]
}

// Base event model
// CTM futures 2017, CTL season 3 division 6b, etc
model Event {
  id            Int @id @default(autoincrement())
  name          String @db.VarChar(256)
  edition       String? @db.VarChar(64)
  organizer     Organization? @relation(fields: [organizerId], references: [id])
  organizerId   Int?
  
  matches       Match[]
  participants  Player[]

  @@unique([name, edition])
}

// Base User model
model User {
  id            Int @id @default(autoincrement())
  username      String? @db.VarChar(64) @unique
  hashed_pw     String?

  player        Player?
  organizations Organization[]
  pronouns      Pronoun[]
}

// Base Player model
model Player {
  id          Int @id @default(autoincrement())
  name        String? @db.VarChar(64) @unique
  user        User? @relation(fields: [userId], references: [id])
  userId      Int?

  playstyles  Playstyle[]
  country     String? @db.VarChar(2) // ISO 2 letter code

  results     Result[]
  events      Event[]
  eloHistory  EloSnapshot[]
}

// A player's result in a game
model Result {
  id          Int @id @default(autoincrement())
  player      Player @relation(fields: [playerId], references: [id])
  playerId    Int
  game        Game @relation(fields: [gameId], references: [id])
  gameId      Int

  styles      Playstyle[]
  rank        Int
  score       Int?

  // one result per player, per game
  @@unique([playerId, gameId])
}

// A game bewteen two or more players
model Game {
  id          Int @id @default(autoincrement())
  results     Result[]
  match       Match @relation(fields: [matchId], references: [id])
  matchId     Int
  timestamp   DateTime?
}

model Match {
  id          Int @id @default(autoincrement())
  games       Game[]
  event       Event @relation(fields: [eventId], references: [id])
  eventId     Int
  type        MatchType @default(COMPETITIVE)
  rom         RomVersion @default(NTSC)
  eloChanges  EloSnapshot[]
  timestamp   DateTime  // required for Elo
  video       String?
  // streamed_on TwitchUser @relation(fields: [twitchId], references: [id])
  // twitchId    Int
}

model EloSnapshot {
  id          Int @id @default(autoincrement())
  player      Player @relation(fields: [playerId], references: [id])
  playerId    Int
  match       Match @relation(fields: [matchId], references: [id])
  matchId     Int
  version     EloVersion @relation(fields: [versionId], references: [id])
  versionId   Int

  index       Int // nth match for player
  victor      Boolean
  newElo      Float

  // one elo snapshot per player, match, and version
  @@unique([playerId, matchId, versionId])
}

model EloVersion {
  id          Int @id @default(autoincrement())
  version     String
  history     EloSnapshot[]
}